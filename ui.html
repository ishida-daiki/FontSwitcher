<Style>
  /* Reset CSS */
  html, body, div, span, object, iframe, h1, h2, h3, h4, h5, h6, p, blockquote, pre, abbr, address, cite, code, del, dfn, em, img, ins, kbd, q, samp, small, strong, sub, sup, var, b, i, dl, dt, dd, ol, ul, li, fieldset, form, label, legend, table, caption, tbody, tfoot, thead, tr, th, td, article, aside, canvas, details, figcaption, figure, footer, header, hgroup, menu, nav, section, summary, time, mark, audio, video {
    margin:0;
    padding:0;
    border:0;
    outline:0;
    font-size:100%;
    vertical-align:baseline;
    background:transparent;
    list-style: none;
  }
  body {
    margin: 0;
    background-color: var(--figma-color-bg);
    color: var(--figma-color-text);
    font-family: 'Inter';
    font-size: 11px;
    font-weight: 400;
    width: 100%;
  }
  svg {
    display: block;
  }
  .tabList {
    position: relative;
    border-bottom: 1px var(--figma-color-border) solid;
    padding-left: 1rem;
    padding-right: 1rem;
    height: 40px;
  }
  .tabList__items {
    display: flex;
    gap: 4px;
    color: var(--figma-color-text-onselected);
    height: 100%;
  }
  .tabList__item {
    display: flex;
    align-items: center;
    margin-right: 0.5rem;
    cursor: pointer;
    height: 100%;
  }
  .tabList__text {
    font-size: .75rem;
    font-weight: bold;
    color: var(--figma-color-text-disabled);
  }
  /* 選択されたタブのテキストスタイル */
  .tabList__item--active .tabList__text {
    /* 太字にする */
    color: var(--figma-color-text);
  }
  /* 選択インジケーターのスタイル */
  .tabList-active-indicator {
    height: 2px; /* インジケーターの高さ */
    background-color: var(--figma-color-bg-component); /* インジケーターの色 */
    width: 100%; /* インジケーターの幅をタブの幅に合わせる */
    position: absolute; /* インジケーターの位置を絶対指定 */
    bottom: -1px; /* インジケーターをタブの下端に位置するように */
    left: 0;
  }
  /* 非アクティブなタブを隠す */
  .tabList-active-indicator--inactive {
    display: none;
  }
  .button-submit {
    padding: 0.8rem 1.5rem;
    width: 100%;
    border-radius: 30px;
    font-weight: 600;
  }
  .button-submit.disabled {
    border: var(--figma-color-border-disabled);
    color: var(--figma-color-text-disabled);
    background: var(--figma-color-bg-disabled);;
  }
  .button-submit.active {
    border: var(--figma-color-border-component);
    color: var(--figma-color-text-onbrand);
    background: var(--figma-color-bg-component);
  }
  .button-submit.active:hover {
    cursor: pointer;
    color: var(--figma-color-text-onbrand);
    background: var(--figma-color-bg-component-hover);
  }
  .button-submit.active:active {
    color: var(--figma-color-text-onbrand);
    background: var(--figma-color-bg-component-pressed);
  }
  .container {
    display: flex;
    flex-direction: column;
    gap: 20px;
    margin: 16px;
  }
  .error {
    color: var(--figma-color-text-danger);
  }

  .tabList__content {
    gap: 8px;
    display: flex;
    flex-direction: column;
  }
  .tabList__title {
    font-weight: 600;
    line-height: 16px;
    letter-spacing: 0.06px;
  }
  .tabList__layer-container {
    display: flex;
    justify-content: space-between;
    cursor: pointer;
    padding: 4 12px;
    border-radius: 4px;
    background: var(--figma-color-bg);
    border: 1px  var(--figma-color-border) solid;
    align-items: center;
  }
  .tabList__layer-container:hover {
    background: var(--figma-color-bg-hover);
  }
  .tabList__layer-container.active {
    background: var(--figma-color-bg);
    border: 1px var(--figma-color-border-oncomponent) solid;
  }
  .tabList__layer-contents {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  .tabList__options-button {
    border: 1px solid transparent; 
    outline: none; 
    display: flex; 
    align-items: center; 
    justify-content: center; 
    height: 32px; 
    width: 32px; 
    flex: 0 0 32px; 
    line-height: 32px; 
    cursor: default; 
    fill: var(--figma-color-icon, #000);
    color: var(--figma-color-icon, #000);
    border-radius: 3px;
    background-clip: padding-box; 
    background-color: transparent;
  }
  .tabList__options-button:hover {
    background-color: var(--figma-color-bg-hover, rgba(0, 0, 0, .06));
    border-radius: 3px;
  }
  /* ボタンがホバーされた時にポップアップを表示する */
  .tabList__options-button:hover + .tabList__popup {
    display: block;
  }
  .tabList__layer-content {
    font-weight: 400;
  }
  

  .listContainer {
    overflow: auto;
    padding: 0;
    height: 96px;
  }
  .listMessage {
    display: grid;
    place-content: center;
    height: 100%;
    background-color: var(--figma-color-bg-secondary);
    padding: 0 16px;
    line-height: 1.5;
  }
  .center {
    text-align: center;
  }
  .text {
    padding-top: 1px;
    color: var(--figma-color-text-disabled);
    pointer-events: none;
  }
  .container__border {
    height: 1px;
    background: var(--figma-color-border);
  }
  .tabList__svg {
    fill: var(--figma-color-icon);
    width: 12;
    height: 12;
  }
  /* ローディングインジケーターのスタイル */
  .loading-indicator {
    /* 必要に応じて他のスタイルを追加 */
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: var(--figma-color-bg-inverse);
    display: flex;
    flex-direction: column;
    align-content: center;
    align-items: center;
    opacity: 95%;
  }
  .progress-ring {
    width: 240px;
    height: 240px;
  }
  .progress-ring__circle {
    transition: stroke-dashoffset 0.35s;
    transform: rotate(-90deg);
    transform-origin: 50% 50%;
  }
  .progress-text {
    color: var(--figma-color-text-oninverse);
  }
.select-content {
  display: flex;
}

  /* Additional styles for 'select' dropdown */
.select-container {
  position: relative;
  margin-bottom: 10px;
}

.select-dropdown {
  padding: 4px;
  border: 1px solid var(--figma-color-border);
  background-color: var(--figma-color-bg);
  border-radius: 4px;
  width: 100%;
  font-family: 'Inter', sans-serif;
  font-size: 11px;
  cursor: pointer;
  appearance: none; /* Disables the native drop-down arrow */
}

.select-dropdown:focus {
  outline: none;
  border-color: var(--figma-color-border-focus);
}

/* Style for custom dropdown arrow */
.select-arrow {
  position: absolute;
  right: 10px;
  top: 50%;
  transform: translateY(-50%);
  pointer-events: none; /* Makes sure the svg does not prevent clicking the select box */
}

.select-arrow svg {
  fill: var(--figma-color-icon); /* Icon color */
}

.create-style.font-family {
  display: flex;
  flex-direction: column;
  max-height: 295px;
  top: calc(100% + 1px);
  -webkit-font-smoothing: antialiased;
  pointer-events: none;
  background-color: #1e1e1e;
  border-radius: var(--border-radius-2);
  box-shadow: var(--box-shadow-menu);
  color: #fff;
  font-size: var(--font-size-12);
  left: 0;
  min-width: 100%;
  overflow-y: auto;
  padding: var(--space-extra-small) 0;
  position: absolute;
}
.font-family_label {
  position: relative;
  padding: 4px var(--space-medium) 4px 32px;
  text-overflow: ellipsis;
  white-space: nowrap;
  display: block;
}

.font-family_labelText {
  display: block;
  position: absolute;
  top: 0;
  right: 0;
  bottom: 0;
  left: 0;
  height: 100%;
  width: 100%;
}

.font-menu {
  width: 100%;
  height: 100%;
  padding-top: 8px;
  padding-bottom: 8px;
  background: #222222;
  box-shadow: 0px 5px 17px rgba(0, 0, 0, 0.20);
  border-radius: 2px;
  border: 0.50px solid rgba(0, 0, 0, 0.10);
  flex-direction: column;
  justify-content: flex-start;
  align-items: flex-start;
  display: inline-flex;
}



.font-menu__item {
  width: 100%;
  height: 24px;
  position: relative;
}
.font-menu__item:hover {
  background: #18A0FB;
}

.font-menu__divider {
  width: 100%;
  height: 17px;
  position: relative;
  display: flex;
  align-items: center;
}
.font-menu__divider_item {
  width: 100%;
  border: 1px rgba(255, 255, 255, 0.20) solid;
}

.font-menu__text {
  display: flex;
  align-items: center;
  width: 100%;
  height: 24px;
  left: 32px;
  top: 0px;
  position: absolute;
  color: white;
  font-size: 12px;
  font-family: Inter;
  font-weight: 400;
  line-height: 16px;
  letter-spacing: 0.06px;
  word-wrap: break-word;
}

.font-menu__icon {
  width: 16px;
  height: 16px;
  left: 8px;
  top: 4px;
  position: absolute;
}

.font-menu__icon-img {
  width: 9.91px;
  height: 7.62px;
  left: 3.29px;
  top: 3.79px;
  position: absolute;
}

  /* 非表示にするためのクラス */
  .hidden {
    display: none;
  }

  /* ルート要素 (Block) */
.tabList__container {
  width: 100%;
  height: 100%;
  display: flex;
  justify-content: space-between;
  align-items: center;
  position: relative;
}

/* ポップアップコンテナ (Element) */
.tabList__popup {
  position: absolute;
  bottom: -34px;
  right: 0;
  display: none;
}

/* ポップアップコンテナ (Element Modifier) */
.tabList__popup--visible {
  display: block;
}

/* ポップアップアローのコンテナ (Element) */
.tabList__popup-arrow-container {
  position: relative;
}

/* ポップアップの内容 (Element) */
.tabList__popup-content {
  height: 28px;
  border-radius: 2px;
  background: #222222;
  color: #FFFFFF;
  box-shadow: 0px 2px 7px rgba(0, 0, 0, 0.15);
  padding: 0 8px;
  display: flex;
  align-items: center;
}

/* ポップアップアロー (Element) */
.tabList__popup-arrow {
  position: absolute;
  top: -6px;
  left: 70px;
  right: 0;
}

</Style>
<body>
  <!-- tabList -->
  <div class="tabList">
    <ul class="tabList__items">
      <li class="tabList__item">
        <span class="tabList__text">Apply Styles</span>
      </li>
      <li class="tabList__item">
        <span class="tabList__text">Create Style</span>
      </li>
    </ul>
    <div class="tabList-active-indicator"></div>
  </div>
  <!-- 要素選択 and  -->
  <div class="container">
    <!-- 要素選択 -->
    <div class="listContainer">
      <div class="listMessage">
        <p class="text center">Select the element whose <br> text you want to change</p>
      </div>
    </div>
    <!-- 区切り線 -->
    <div class="container__border"></div>
    <!-- 登録したテキストスタイル一覧 -->
    <div class="tabList__content">
      <div class="tabList__container">
        <h2 class="tabList__title">Style List</h2>
        <button class="tabList__options-button" role="button" type="button" aria-label="追加">
          <span class="svg-container">
            <svg class="tabList__svg" 'xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 12 12"><path fill: var(--figma-color-icon); fill-opacity="1" fill-rule="nonzero" stroke="none" d="M5.5 5.5v-5h1v5h5v1h-5v5h-1v-5h-5v-1h5z"></path>
            </svg>
          </span>
        </button>
        <div class="tabList__popup">
          <div class="tabList__popup-arrow-container">
            <div class="tabList__popup-content">新しいスタイル</div>
            <div class="tabList__popup-arrow">
              <svg width="13" height="7" viewBox="0 0 13 7" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M6.5 0L13 6.5H0L6.5 0Z" fill="#222222"/>
              </svg>
            </div>
          </div>
        </div>
      </div>

      <!-- <h2 class="tabList__title">Style List</h2> -->
      <ul class="tabList__layer-contents">
        <li class="tabList__layer-container" data-env="mac">
          <h3 class="tabList__layer-content">Mac 環境確認用</h3>
          <button class="tabList__options-button" tabindex="0" aria-label="その他のオプション" data-tooltip-type="text" data-tooltip="その他のオプション">
            <span class="tabList__svg-container">
              <svg class="tabList__svg" 'xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 6">
                <path fill-opacity="1" fill-rule="nonzero" stroke="none" d="M3.5 3c0 .828-.672 1.5-1.5 1.5C1.172 4.5.5 3.828.5 3c0-.828.672-1.5 1.5-1.5.828 0 1.5.672 1.5 1.5zm6 0c0 .828-.672 1.5-1.5 1.5-.828 0-1.5-.672-1.5-1.5 0-.828.672-1.5 1.5-1.5.828 0 1.5.672 1.5 1.5zM14 4.5c.828 0 1.5-.672 1.5-1.5 0-.828-.672-1.5-1.5-1.5-.828 0-1.5.672-1.5 1.5 0 .828.672 1.5 1.5 1.5z"></path>
              </svg>
            </span>
          </button>
        </li>
        <li class="tabList__layer-container" data-env="windows">
          <h3 class="tabList__layer-content">Windows 環境確認用</h3>
          <button class="tabList__options-button" tabindex="0" aria-label="その他のオプション" data-tooltip-type="text" data-tooltip="その他のオプション">
            <span class="tabList__svg-container">
              <svg class="tabList__svg" 'xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 6">
                <path fill-opacity="1" fill-rule="nonzero" stroke="none" d="M3.5 3c0 .828-.672 1.5-1.5 1.5C1.172 4.5.5 3.828.5 3c0-.828.672-1.5 1.5-1.5.828 0 1.5.672 1.5 1.5zm6 0c0 .828-.672 1.5-1.5 1.5-.828 0-1.5-.672-1.5-1.5 0-.828.672-1.5 1.5-1.5.828 0 1.5.672 1.5 1.5zM14 4.5c.828 0 1.5-.672 1.5-1.5 0-.828-.672-1.5-1.5-1.5-.828 0-1.5.672-1.5 1.5 0 .828.672 1.5 1.5 1.5z"></path>
              </svg>
            </span>
          </button>
        </li>
      </ul>
    </div>
    <!-- 反映ボタン -->
    <button id="analyzeBtn" class="button-submit disabled">Apply</button>

    


    <!-- fontFamilyのカスタムリスト -->
    <div class="_textbox_sir3b_1">
      <div>
        <input class="_input_1m36p_59" id="fontFamilyInput" autocomplete="off" placeholder="Select Font Family">
        <div class="font-menu hidden" role="menu" id="fontFamilyListContainer">
        </div>
      </div>
    </div>
  </div>
  <!-- ローディングインジケーター -->
  <div id="loadingIndicator" class="loading-indicator hidden">
    <svg class="progress-ring" viewBox="0 0 240 240">
      <circle
        class="progress-ring__circle"
        stroke="var(--figma-color-bg-component)"
        stroke-width="10"
        fill="transparent"
        r="52"  
        cx="120"
        cy="120"
      />
    </svg>
    <span class="progress-text">Applying fonts...</span> 
  </div>
</body>

<script>
  // 要素を取得します。
  const tabs = document.querySelectorAll('.tabList__item');
  const textStyles = document.querySelectorAll('.tabList__layer-container')
  const indicator = document.querySelector('.tabList-active-indicator');
  const loader = document.querySelectorAll('.loading-indicator');

  // 選択された要素とstyleの状態を表示
  let selectedEnv = null;
  let hasSelection = false;
  let isEnvSelected = false;

  // 利用可能な全フォント情報を格納する変数
  let availableFonts = []; // Figma APIから取得するデータ

  // 利用可能なフォントをロードするためにメインスクリプトに要求する
  parent.postMessage({ pluginMessage: { type: 'load-fonts-request' } }, '*');

  // タブが選択された際の関数を定義します。
  function activateTab(tab) {
    // すべてのタブからアクティブクラスを取り除きます。
    tabs.forEach(t => {
      t.classList.remove('tabList__item--active');
    });
    
    // 選択されたタブにアクティブクラスを追加します。
    tab.classList.add('tabList__item--active');
    
    // インジケーターを活性状態にして、選択されたタブの位置に合わせます。
    indicator.style.display = 'block';
    indicator.style.width = '74px';
    indicator.style.left = `${tab.offsetLeft}px`;
  }
  // タブをクリックした際のイベントリスナーを追加します。
  tabs.forEach(tab => {
    tab.addEventListener('click', () => activateTab(tab));
  });
  // 初期状態（ページ読み込み時）で「Apply Styles」タブをアクティブにします。
  activateTab(tabs[0]); // 最初のタブをアクティブとする

  // progress-ring__circleと同じ値をセットし、
  // SVGの円周の長さを計算する式: 2 * Math.PI * r (半径)
  const circumference = 2 * Math.PI * 52;

  // 最初に円をリングとして表示するために、
  // stroke-dasharrayとstroke-dashoffsetを円周の長さにセットします
  const circle = document.querySelector('.progress-ring__circle');
  circle.style.strokeDasharray = `${circumference} ${circumference}`;
  circle.style.strokeDashoffset = circumference;

  function setProgress(percent) {
    // パーセントに応じたオフセットを計算します
    const offset = circumference - (percent / 100 * circumference);
    // オフセットを設定することでリングを描画します
    circle.style.strokeDashoffset = offset;
  }

  // メッセージがプラグインから送信されたときにイベントを発火させる
  window.onmessage = (event) => {
    const message = event.data.pluginMessage;

    // 共通のエレメントを取得
    const textElement = document.querySelector('.listMessage .text.center'); // textElementをここで定義
    const loadingIndicator = document.getElementById('loadingIndicator');

    switch (message.type) {
      // 選択した要素関連メッセージ
      case 'selection-cleared':
        textElement.innerHTML = 'Select the element whose <br> text you want to change'
        textElement.style.color = 'var(--figma-color-text-disabled)';
        textElement.style.fontWeight = '400';
        hasSelection = false;
        updateButtonState();
        break;
      case 'update-name':
        textElement.textContent = message.name;
        textElement.style.color = 'var(--figma-color-text)';
        textElement.style.fontWeight = '600';
        hasSelection = true;
        updateButtonState();
        break;
      
      // ローディング表示関連メッセージ
      // case 'show-loading':
      //   loadingIndicator.classList.remove('hidden');
      case 'update-progress':
        loadingIndicator.classList.remove('hidden');
        // 進捗状況のパーセンテージを受け取る
        const progressPercent = event.data.pluginMessage.progress;
        // 進捗インジケータを更新する
        setProgress(progressPercent);
        break;
      case 'hide-loading':
        loadingIndicator.classList.add('hidden');
        break;

      // figma内のfont.familyとstyleをselectボックス内に追加
      case 'load-fonts':
        const listContainer = document.getElementById('fontFamilyListContainer');
        listContainer.innerHTML = '';  // 既存のリスト内容を一度クリアする
        availableFonts = message.fonts;  // メッセージからフォント情報を取得する
        
        // 重複せずにフォントファミリー名を記録するためのSetを作成
        const addedFontFamilies = new Set();
        availableFonts.forEach((font) => {
          // フォントファミリー名が既に追加されていなければ操作を行う
          if (!addedFontFamilies.has(font.fontName.family)) {
            addedFontFamilies.add(font.fontName.family);  // Setにフォントファミリー名を追加

            // 新しいフォントファミリーのメニュー項目を作成
            const item = document.createElement('div');
            item.className = 'font-menu__item';
            item.setAttribute('role', 'menuitem');

            // フォントファミリー名を表示するためのテキスト部分を作成
            const text = document.createElement('div');
            text.className = 'font-menu__text';
            text.textContent = font.fontName.family;
            item.appendChild(text);

            // リストにメニュー項目を追加
            listContainer.appendChild(item);
            // 利用可能なfontFamilyの情報を保持する配列（サンプルで用意）
          }
          const listInput = document.getElementById('fontFamilyInput');
          listInput.addEventListener('click', function() {
            if (listContainer.classList.contains('hidden')) {
              listContainer.classList.remove('hidden'); // リストを表示する
            } else {
              listContainer.classList.add('hidden'); // リストを表示する
            }
          });
        });
      break;
    }
  };

  

  // // フォントファミリーの情報は、プラグインから動的に取得されます。
  // window.onmessage = (event) => {
  //   const { type, fonts } = event.data.pluginMessage;
  //   if (type === 'load-fonts') {
  //     fonts.forEach((font) => {
  //       if (!fontFamilies.includes(font.fontName.family)) {
  //         fontFamilies.push(font.fontName.family); // ユニークなフォントファミリー名を配列に追加
  //       }
  //     });
  //   }
  // };

  // Applyボタンの要素を取得し、デフォルトでは無効化する
  const applyBtn = document.getElementById("analyzeBtn"); 
  applyBtn.disabled = true; // 初期状態としてボタンを無効化
  // スタイル選択時のイベントハンドラ
  textStyles.forEach(textStyle => {
    textStyle.addEventListener('click', () => {
      selectedEnv = textStyle.getAttribute('data-env');
      // 他のスタイル名の選択を解除
      textStyles.forEach(ts => ts.classList.remove('active'));
      textStyle.classList.add('active');
      updateButtonState();
    });
  });

  // Applyボタンの初期状態を定義
  applyBtn.disabled = true; // 最初は非活性化しておく

  // Applyボタンの有効/無効ステータスを更新する関数
  function updateButtonState() {
    // selectedEnvがnullでないかをチェックして、isEnvSelectedを更新する
    isEnvSelected = selectedEnv !== null;
    // Applyボタンは環境が選択され、何かが選択されている場合のみ活性化する
    applyBtn.disabled = !(isEnvSelected && hasSelection);

    if (isEnvSelected && hasSelection) {
      applyBtn.classList.remove('disabled');
      applyBtn.classList.add('active');
    } else {
      applyBtn.classList.remove('active');
      applyBtn.classList.add('disabled');
    }
  }

  // UIのHTML中のスクリプトは以下のようになります。
  // UIから送られるメッセージは、上記 figma.ui.onmessage でリッスンされます。
  // When the button is clicked, the plugin will start the text analysis and update
  applyBtn.addEventListener("click", () => {
    parent.postMessage({
        pluginMessage: { 
          type: 'analyzeAndUpdateText',
          fontSettings: {
            env: selectedEnv
          }
        } 
      }, '*');
  });
</script>